{# Modified by Eng Muhammad Abdulghaffar #}
{% extends "base.html" %}
{% block title %}Docker Chat{% endblock %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  .chat-card { animation: fadeIn .8s ease-in; background:#ffffffee; border-radius:15px; backdrop-filter: blur(8px); }
  @keyframes fadeIn { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
  .bubble-me { background:#0d6efd; color:#fff; border-radius:16px 16px 0 16px; }
  .bubble-them { background:#e9ecef; border-radius:16px 16px 16px 0; }
</style>

<div class="container py-4">
  <div class="text-center mb-3">
    <h2 class="fw-bold text-primary"><i class="bi bi-chat-dots"></i> Docker Chat</h2>
    <p class="small text-muted">Real-time chat powered by Flask & Socket.IO</p>
  </div>

  <!-- Auth -->
  <div id="authBox" class="card chat-card shadow-sm mb-4 mx-auto" style="max-width:700px;">
    <div class="card-body">
      <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#login">Login</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#register">Register</button></li>
      </ul>
      <div class="tab-content">
        <div id="login" class="tab-pane fade show active">
          <div class="row g-2 align-items-end">
            <div class="col-md-4"><input id="loginUser" class="form-control" placeholder="Username"></div>
            <div class="col-md-4"><input id="loginPass" class="form-control" type="password" placeholder="Password"></div>
            <div class="col-md-3"><button id="loginBtn" class="btn btn-primary w-100">Login</button></div>
          </div>
          <div id="loginErr" class="text-danger mt-2 small"></div>
        </div>
        <div id="register" class="tab-pane fade">
          <div class="row g-2 align-items-end">
            <div class="col-md-4"><input id="regUser" class="form-control" placeholder="New username"></div>
            <div class="col-md-4"><input id="regPass" class="form-control" type="password" placeholder="New password"></div>
            <div class="col-md-3"><button id="registerBtn" class="btn btn-success w-100">Create</button></div>
          </div>
          <div id="registerErr" class="text-danger mt-2 small"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat -->
  <div id="chatUI" class="card chat-card shadow mx-auto" style="max-width:700px; display:none;">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>Logged in as: <span class="badge bg-primary" id="me"></span></div>
        <div class="d-flex gap-2">
          <select id="peer" class="form-select"></select>
          <button id="openBtn" class="btn btn-outline-primary">Open dialog</button>
        </div>
      </div>
      <div id="messages" class="p-3 border rounded" style="height:350px; overflow-y:auto; background:#f9fafc;"></div>
      <div class="input-group mt-3">
        <input id="msg" class="form-control" placeholder="Type a message...">
        <button id="sendBtn" class="btn btn-success">Send</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  const socket = io();
  const authBox = document.getElementById("authBox");
  const chatUI  = document.getElementById("chatUI");
  const meSpan  = document.getElementById("me");
  const peerSel = document.getElementById("peer");
  const box     = document.getElementById("messages");
  const msgIn   = document.getElementById("msg");
  const loginErr = document.getElementById("loginErr");
  const registerErr = document.getElementById("registerErr");

  function bubble(text, who="me", meta="") {
    const wrap=document.createElement("div");
    wrap.className="d-flex my-2 "+(who==="me"?"justify-content-end":"justify-content-start");
    const b=document.createElement("div");
    b.className="px-3 py-2 small "+(who==="me"?"bubble-me text-white":"bubble-them");
    b.innerHTML=(meta?`<div class='small opacity-75 mb-1'>${meta}</div>`:"")+text;
    wrap.appendChild(b); box.appendChild(wrap); box.scrollTop=box.scrollHeight;
  }

  // Login/Register
  document.getElementById("loginBtn").onclick=()=>{
    const username=document.getElementById("loginUser").value.trim().toLowerCase();
    const password=document.getElementById("loginPass").value.trim();
    socket.emit("login",{username,password});
  };
  document.getElementById("registerBtn").onclick=()=>{
    const username=document.getElementById("regUser").value.trim().toLowerCase();
    const password=document.getElementById("regPass").value.trim();
    socket.emit("register",{username,password});
  };

  socket.on("login_ok",({me,others})=>initChat(me,others));
  socket.on("register_ok",({me,others})=>initChat(me,others));
  socket.on("login_error",({error})=>loginErr.textContent=error||"Login failed");
  socket.on("register_error",({error})=>registerErr.textContent=error||"Registration failed");

  function initChat(me,others){
    authBox.style.display="none"; chatUI.style.display="block";
    meSpan.textContent=me; peerSel.innerHTML="";
    (others||[]).forEach(u=>{
      const opt=document.createElement("option"); opt.value=u; opt.textContent=u; peerSel.appendChild(opt);
    });
    bubble(`Welcome <b>${me}</b>! Choose someone to start chatting.`,"them");
  }

  // Chat
  document.getElementById("openBtn").onclick=()=>{
    const who=peerSel.value; if(!who) return;
    box.innerHTML=""; socket.emit("open_dialog",{with:who});
  };
  socket.on("history",({with:withUser,messages})=>{
    bubble(`Chat with <b>${withUser}</b> — last ${messages.length} messages:`,"them");
    (messages||[]).forEach(m=> bubble(m.text, m.from==="me"?"me":"them", m.at));
  });

  document.getElementById("sendBtn").onclick=()=>{
    const text=msgIn.value.trim(); if(!text) return;
    const to=peerSel.value; socket.emit("chat_message",{to,text}); msgIn.value="";
  };
  msgIn.addEventListener("keyup",e=>{ if(e.key==="Enter") document.getElementById("sendBtn").click(); });

  socket.on("chat_message",({from,to,text,at})=>{
    const who=(from===meSpan.textContent)?"me":"them"; bubble(text,who,`${from} • ${at}`);
  });
</script>
{% endblock %}
