<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Docker Chat</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons (for lil vibes) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --bg: #0f1221;
      --glass: #12162aee;
      --accent: #7c5cff;
      --accent-2:#00e6a8;
      --text:#e7e8ee;
      --muted:#9aa0b4;
      --danger:#ff6b6b;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
    }
    html,body{ height:100%; background:
      radial-gradient(1200px 800px at -10% -10%, #233 0%, transparent 50%),
      radial-gradient(1200px 900px at 110% 10%, #221a38 0%, transparent 50%),
      linear-gradient(180deg, #0b0f1d 0%, #0f1221 100%); color: var(--text); }
    a{ color: var(--accent); text-decoration: none; }
    .app-shell{ max-width:1200px; margin:24px auto; padding:12px; }
    .glass{ background: var(--glass); backdrop-filter: blur(9px); border:1px solid #2b3150; border-radius: var(--radius); box-shadow: var(--shadow); }
    .brand{ font-weight: 800; letter-spacing:.3px; }
    .chip{ font-size:.75rem; color:var(--muted); border:1px solid #36406b; border-radius:999px; padding:.2rem .55rem; }
    .btn-accent{ background: linear-gradient(135deg, var(--accent) 0%, #9f83ff 100%); border:none; color:#fff; }
    .btn-accent:hover{ filter: brightness(1.04); }
    .btn-ghost{ background:transparent; border:1px solid #333a61; color:#cfd3e6; }
    .btn-dangerish{ background:#2a1820; border:1px solid #613248; color:#ff94b4; }
    .muted{ color: var(--muted); }
    .divider{ height:1px; background: #2b3150; margin: 10px 0; }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:14px;
      min-height: 70vh;
    }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    /* Sidebar */
    .sidebar{ padding:14px; }
    .user-pill{
      display:flex; align-items:center; gap:10px;
      padding:.6rem .75rem; border-radius:12px; cursor:pointer;
      transition: background .15s ease;
    }
    .user-pill:hover{ background:#1a1f35; }
    .user-pill.active{ background:#202645; border:1px solid #3a4270; }
    .avatar{
      width:34px; height:34px; border-radius:999px; background:#1e243f; display:grid; place-items:center;
      font-weight:700; color:#c9cff5; border:1px solid #343b63;
    }
    .badge-dot{ width:8px; height:8px; border-radius:999px; background: var(--accent-2); box-shadow: 0 0 0 3px #15352f; }

    /* Chat panel */
    .chat{ padding:14px; display:flex; flex-direction:column; min-height: 520px; }
    .chat-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding-bottom:8px; border-bottom:1px solid #2b3150; }
    .chat-body{ flex:1; overflow:auto; padding:14px 4px 8px; }
    .msg{
      max-width: 70%; padding:.55rem .8rem; border-radius:14px; margin:.25rem 0;
      background:#1a1f35; border:1px solid #2e3560; color:#dee2ff; word-wrap: break-word;
    }
    .msg.me{ margin-left:auto; background:#1b233f; border-color:#3a4375; }
    .msg .meta{ display:flex; gap:8px; font-size:.72rem; color:#9aa0b4; margin-top:6px; }
    .msg .bubble{ white-space: pre-wrap; line-height:1.35; }

    .composer{ display:flex; gap:8px; padding:10px; border-top:1px solid #2b3150; }
    .composer input, .composer textarea{
      background:#12162a; border:1px solid #333a61; color:#dfe3ff; border-radius:12px; padding:.7rem .9rem; width:100%;
    }
    .composer textarea{ resize:none; height:48px; }
    .composer .send{ min-width:110px; }

    /* Auth card */
    .auth{ padding:16px; }
    .tab-btn{ padding:.45rem .8rem; border-radius:999px; border:1px solid #333a61; }
    .tab-btn.active{ background:#1a1f35; border-color:#3a4270; }
    .toastish{
      position: fixed; right: 16px; bottom: 16px; padding:.7rem .9rem; border-radius:12px;
      background:#231426; border:1px solid #5a2f50; color:#ffc7da; box-shadow:var(--shadow); display:none;
    }
    .toastish.show{ display:block; animation: pop .18s ease-out; }
    @keyframes pop{ from{ transform: translateY(6px); opacity:.5;} to{ transform: translateY(0); opacity:1;} }

    /* Empty state */
    .empty{
      display:grid; place-items:center; height:100%;
      color:#a5acc7;
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-2">
        <span class="brand fs-4">Docker Chat</span>
        <span class="chip">Flask Â· Socket.IO Â· MySQL</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span id="whoami" class="muted">not signed in</span>
        <button id="logoutBtn" class="btn btn-sm btn-dangerish d-none"><i class="bi bi-box-arrow-right me-1"></i>Logout</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Auth + People -->
      <div class="glass sidebar">
        <div class="auth">
          <div class="d-flex align-items-center gap-2 mb-2">
            <button class="tab-btn active" data-tab="login">Login</button>
            <button class="tab-btn" data-tab="register">Register</button>
          </div>

          <form id="loginForm" class="row g-2" autocomplete="off">
            <div class="col-12">
              <label class="form-label">Username</label>
              <input class="form-control" id="loginUser" placeholder="e.g. alice" required>
            </div>
            <div class="col-12">
              <label class="form-label">Password</label>
              <input class="form-control" id="loginPass" type="password" placeholder="your password" required>
            </div>
            <div class="col-12 d-grid"><button class="btn btn-accent" type="submit"><i class="bi bi-box-arrow-in-right me-1"></i>Login</button></div>
          </form>

          <form id="registerForm" class="row g-2 d-none" autocomplete="off">
            <div class="col-12">
              <label class="form-label">New username</label>
              <input class="form-control" id="regUser" placeholder="e.g. bob" required>
            </div>
            <div class="col-12">
              <label class="form-label">New password</label>
              <input class="form-control" id="regPass" type="password" placeholder="min 6 chars" minlength="6" required>
            </div>
            <div class="col-12 d-grid"><button class="btn btn-accent" type="submit"><i class="bi bi-person-plus me-1"></i>Create account</button></div>
          </form>
        </div>

        <div class="divider"></div>

        <div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">People</div>
            <span class="chip"><i class="bi bi-people me-1"></i><span id="countOthers">0</span></span>
          </div>
          <div id="usersList" class="d-flex flex-column gap-1">
            <!-- user-pill items injected here -->
          </div>
        </div>
      </div>

      <!-- Right: Chat -->
      <div class="glass chat">
        <div class="chat-header">
          <div class="d-flex align-items-center gap-3">
            <div class="avatar" id="roomAvatar">?</div>
            <div>
              <div id="roomTitle" class="fw-bold">No chat selected</div>
              <div class="muted small" id="roomSub">pick someone from the left to load history</div>
            </div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="chip" id="connInfo">socket: â€”</span>
          </div>
        </div>

        <div id="chatBody" class="chat-body">
          <div class="empty">no messages yet â€” say hi ðŸ‘‹</div>
        </div>

        <div class="composer">
          <textarea id="msgBox" placeholder="Type a messageâ€¦ (Enter to send, Shift+Enter for new line)" disabled></textarea>
          <button id="sendBtn" class="btn btn-accent send" disabled><i class="bi bi-send-fill me-1"></i>Send</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toastish"><span id="toastMsg">Error</span></div>

  <!-- Scripts -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    // --- helpers ---
    const $ = sel => document.querySelector(sel);
    const el = (tag, cls) => { const e = document.createElement(tag); if (cls) e.className = cls; return e; };
    const toast = (msg) => { const t = $('#toast'); $('#toastMsg').textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2600); };
    const initials = (name) => (name||'?').slice(0,2).toUpperCase();

    // --- state ---
    let socket;
    let me = null;          // my username
    let currentPeer = null; // recipient username
    let users = [];         // others list

    // --- socket setup ---
    function connectSocket(){
      socket = io({ transports: ['websocket', 'polling'] });

      socket.on('connect', () => {
        $('#connInfo').textContent = 'socket: ' + socket.id;
      });

      socket.on('disconnect', () => {
        $('#connInfo').textContent = 'socket: â€”';
      });

      socket.on('server_event', (data) => {
        // on_connect emits this
        if (data?.sid) $('#connInfo').textContent = 'socket: ' + data.sid;
      });

      socket.on('register_ok', (payload) => {
        me = payload.me; users = payload.others || [];
        afterAuth('registered');
      });

      socket.on('register_error', (e) => toast(e?.error || 'register failed'));
      socket.on('login_error', (e) => toast(e?.error || 'login failed'));

      socket.on('login_ok', (payload) => {
        me = payload.me; users = payload.others || [];
        afterAuth('logged in');
      });

      socket.on('dialog_error', (e)=> toast(e?.error || 'dialog error'));
      socket.on('send_error', (e)=> toast(e?.error || 'send error'));

      socket.on('history', ({with: peer, messages})=>{
        currentPeer = peer;
        renderRoom(peer);
        renderHistory(messages||[]);
        enableComposer(true);
      });

      socket.on('chat_message', (msg)=>{
        // msg = {from, to, text, at}
        if (!me) return;
        const peer = (msg.from===me) ? msg.to : msg.from;
        // if message belongs to current open dialog, append it; else refresh sidebar badge later
        if (peer === currentPeer || msg.from===currentPeer){
          appendMsg(msg);
        }
        // sidebar mini "ping" handled by re-render (could add unread indicators if you want)
        // For simplicity, just re-render users to bubble the active one to top
        renderUsers(users);
      });
    }

    // --- UI wiring ---
    function afterAuth(action){
      $('#whoami').textContent = me ? ('signed in as @'+me) : 'not signed in';
      $('#logoutBtn').classList.toggle('d-none', !me);
      renderUsers(users);
      toast('Success: ' + action);
      // switch to login tab (just cosmetic)
      setTab('login');
    }

    function renderUsers(list){
      const box = $('#usersList');
      box.innerHTML = '';
      $('#countOthers').textContent = list.length;
      if (list.length === 0){
        const p = el('div','muted small'); p.textContent = 'nobody here yet â€” create another user in register ðŸ˜‰';
        box.appendChild(p);
        return;
      }
      list.forEach(u=>{
        const item = el('div','user-pill' + (u===currentPeer?' active':''));
        const avatar = el('div','avatar'); avatar.textContent = initials(u);
        const nameWrap = el('div');
        const name = el('div'); name.textContent = '@'+u;
        const sub = el('div','small muted d-flex align-items-center gap-2');
        const dot = el('span','badge-dot'); sub.appendChild(dot);
        const t = el('span'); t.textContent = 'online';
        sub.appendChild(t);
        nameWrap.appendChild(name); nameWrap.appendChild(sub);
        item.appendChild(avatar); item.appendChild(nameWrap);
        item.onclick = ()=> openDialog(u);
        box.appendChild(item);
      });
    }

    function renderRoom(peer){
      $('#roomTitle').textContent = '@' + peer;
      $('#roomSub').textContent = 'private chat Â· end-to-end? not yet (server-side), but messages are private per-user rooms';
      $('#roomAvatar').textContent = initials(peer);
      $('#chatBody').innerHTML = '';
    }

    function renderHistory(messages){
      const body = $('#chatBody');
      if (!messages.length){
        const empty = el('div','empty'); empty.textContent = 'no history â€” start the convo âœ¨';
        body.appendChild(empty); return;
      }
      messages.forEach(m=>{
        const msg = {
          from: m.from === 'me' ? me : currentPeer,
          to:   m.from === 'me' ? currentPeer : me,
          text: m.text,
          at:   m.at
        };
        appendMsg(msg);
      });
      body.scrollTop = body.scrollHeight;
    }

    function appendMsg(msg){
      const mine = msg.from === me;
      const row = el('div', 'msg' + (mine?' me':''));
      const bubble = el('div','bubble'); bubble.textContent = msg.text;
      const meta = el('div','meta');
      const who = el('span'); who.textContent = mine ? 'You' : '@'+msg.from;
      const when = el('span'); when.textContent = new Date(msg.at).toLocaleString();
      meta.appendChild(who); meta.appendChild(when);
      row.appendChild(bubble); row.appendChild(meta);
      $('#chatBody').appendChild(row);
      $('#chatBody').scrollTop = $('#chatBody').scrollHeight;
    }

    function enableComposer(on){
      $('#msgBox').disabled = !on;
      $('#sendBtn').disabled = !on;
      if (on) $('#msgBox').focus();
    }

    function openDialog(peer){
      if (!me){ toast('login first'); return; }
      currentPeer = peer;
      socket.emit('open_dialog', { with: peer });
      // optimistic header change while history loads
      renderRoom(peer);
      $('#chatBody').innerHTML = '<div class="empty">loading historyâ€¦</div>';
    }

    function sendMessage(){
      const text = $('#msgBox').value;
      if (!text.trim() || !currentPeer){ return; }
      socket.emit('chat_message', { to: currentPeer, text });
      // local echo is handled by server broadcasting back, so just clear box
      $('#msgBox').value = '';
      $('#msgBox').focus();
    }

    // tab switch
    function setTab(which){
      document.querySelectorAll('.tab-btn').forEach(b=>{
        b.classList.toggle('active', b.dataset.tab===which);
      });
      $('#loginForm').classList.toggle('d-none', which!=='login');
      $('#registerForm').classList.toggle('d-none', which!=='register');
    }

    // --- events ---
    document.addEventListener('DOMContentLoaded', ()=>{
      connectSocket();

      document.querySelectorAll('.tab-btn').forEach(b=>{
        b.addEventListener('click', ()=> setTab(b.dataset.tab));
      });

      $('#loginForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const username = $('#loginUser').value.trim();
        const password = $('#loginPass').value.trim();
        if (!username || !password) return;
        socket.emit('login', { username, password });
      });

      $('#registerForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const username = $('#regUser').value.trim();
        const password = $('#regPass').value.trim();
        if (!username || !password) return;
        socket.emit('register', { username, password });
      });

      $('#logoutBtn').addEventListener('click', ()=>{
        me = null; currentPeer = null; users = [];
        $('#whoami').textContent = 'not signed in';
        $('#logoutBtn').classList.add('d-none');
        $('#usersList').innerHTML = '';
        $('#countOthers').textContent = '0';
        $('#roomTitle').textContent = 'No chat selected';
        $('#roomSub').textContent = 'pick someone from the left to load history';
        $('#roomAvatar').textContent = '?';
        $('#chatBody').innerHTML = '<div class="empty">no messages yet â€” say hi ðŸ‘‹</div>';
        enableComposer(false);
        // hard reset socket mapping on server by reconnecting
        try{ socket.disconnect(); }catch{}
        setTimeout(()=>connectSocket(), 150);
      });

      $('#sendBtn').addEventListener('click', sendMessage);
      $('#msgBox').addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' && !e.shiftKey){
          e.preventDefault(); sendMessage();
        }
      });
    });
  </script>
</body>
</html>

